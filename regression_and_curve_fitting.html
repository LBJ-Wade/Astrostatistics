
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Regression and Curve Fitting &#8212; Astrostatistics</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Colored Noise" href="colored_noise.html" />
    <link rel="prev" title="PHY 688: Computational Astrophysics Syllabus" href="syllabus.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Astrostatistics</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   PHY 688: Numerical Methods in Astrophysics.
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="welcome.html">
   An Example to Set the Stage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="syllabus.html">
   PHY 688: Computational Astrophysics Syllabus
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Regression and Curve Fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="colored_noise.html">
   Colored Noise
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="populations.html">
   Populations and Catalogs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="selection_effects.html">
   Selection Effects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="special_methods.html">
   Special Methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tips_and_tricks.html">
   Tips and Tricks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="project_ideas.html">
   Project Ideas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bibliography.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/regression_and_curve_fitting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/farr/Astrostatistics"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/farr/Astrostatistics/issues/new?title=Issue%20on%20page%20%2Fregression_and_curve_fitting.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/farr/Astrostatistics/main?urlpath=tree/astrostatistics/regression_and_curve_fitting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-regression-example-fake-data">
   Linear Regression Example (Fake Data!)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#uncertian-about-x">
     Uncertian About
     <span class="math notranslate nohighlight">
      \(x\)
     </span>
     ?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#treatment-of-outliers">
     Treatment of Outliers
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#radial-velocity-curves-and-exoplanet-orbital-parameters">
   Radial Velocity Curves and Exoplanet Orbital Parameters
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problems">
   Problems
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#linear-regression">
     Linear Regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hd126614a">
     HD126614A
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-planet-of-your-choosing">
     A Planet of Your Choosing
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="regression-and-curve-fitting">
<h1>Regression and Curve Fitting<a class="headerlink" href="#regression-and-curve-fitting" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pylab</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;

<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">daft</span>
<span class="kn">import</span> <span class="nn">exoplanet</span> <span class="k">as</span> <span class="nn">xo</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">pymc3_ext</span> <span class="k">as</span> <span class="nn">pmx</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">T</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;notebook&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s1">&#39;colorblind&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;ticks&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Populating the interactive namespace from numpy and matplotlib
</pre></div>
</div>
</div>
</div>
<p>Regression is statistics-speak for analyzing a data set where one (or more) variables are measured perfectly or under the control of the experimenter (these are sometimes called “predictors,” “covariates,” “independent variables,” …), and one (or more) variables are measured (sometimes imperfectly) but not under the control of the experimenter.  Astronomers are often less precise, and sometimes use “regression” to refer to any time the dependence between two or more parameters is analyzed.  <strong>Note: I am actually not totally sure what “regression” means—nor, I think, is anyone.  This is a pretty good definition.  You’ll come to know it when you see it.</strong></p>
<div class="section" id="linear-regression-example-fake-data">
<h2>Linear Regression Example (Fake Data!)<a class="headerlink" href="#linear-regression-example-fake-data" title="Permalink to this headline">¶</a></h2>
<p>Let’s go thorugh a mock example first, a form of linear regression (later we will return to this example, which is analytically solvable, in fact!).  We will construct a linear relationship between <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span>:
$<span class="math notranslate nohighlight">\(
y = m x + b
\)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_true</span> <span class="o">=</span> <span class="mf">2.5</span>
<span class="n">b_true</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span>

<span class="n">xs</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">ys_true</span> <span class="o">=</span> <span class="n">m_true</span><span class="o">*</span><span class="n">xs</span> <span class="o">+</span> <span class="n">b_true</span>

<span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys_true</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_5_1.png" src="_images/regression_and_curve_fitting_5_1.png" />
</div>
</div>
<p>Now we assume that we make imperfect observations of the “output” variables <span class="math notranslate nohighlight">\(y\)</span>.  For now, we set things up “homoskedastically” (whew! it means: with the same error or scatter in each observation):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ys_obs</span> <span class="o">=</span> <span class="n">ys_true</span> <span class="o">+</span> <span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ys_true</span><span class="p">))</span>
<span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys_obs</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y_\mathrm</span><span class="si">{obs}</span><span class="s1">$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y_\\mathrm{obs}$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_7_1.png" src="_images/regression_and_curve_fitting_7_1.png" />
</div>
</div>
<p>We can write a reasonable joint distribution for <span class="math notranslate nohighlight">\(m\)</span>, <span class="math notranslate nohighlight">\(b\)</span>, and the observed <span class="math notranslate nohighlight">\(y\)</span> concisely in a <code class="docutils literal notranslate"><span class="pre">pymc3</span></code> model; it looks a lot like the <code class="docutils literal notranslate"><span class="pre">Turing</span></code> models we saw in previous chapters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    
    <span class="n">ys_true</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;ys_true&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="n">xs</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;ys_obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">ys_true</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">ys_obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s unpack this a bit.  First, we can draw our model graphically:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$m$&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$b$&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$x_i$&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$y_{i,\mathrm</span><span class="si">{obs}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_i$&#39;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_plate</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$i = 1, \ldots, N$&#39;</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes:&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_11_1.png" src="_images/regression_and_curve_fitting_11_1.png" />
</div>
</div>
<p>Our model here says that we are making repeated observations of <span class="math notranslate nohighlight">\(y_i\)</span>, <span class="math notranslate nohighlight">\(i = 1, \ldots, N\)</span>.  For each observation, we are also given the value(s) of <span class="math notranslate nohighlight">\(x_i\)</span> and <span class="math notranslate nohighlight">\(\sigma_i\)</span>.  The observed value <span class="math notranslate nohighlight">\(y_i\)</span> depends on these inputs, as well as the parameters <span class="math notranslate nohighlight">\(m\)</span> and <span class="math notranslate nohighlight">\(b\)</span>.  The <em>form</em> of this dependence is specified in the model above:
$<span class="math notranslate nohighlight">\(
y_i \sim N\left( m x_i + b, \sigma_i \right).
\)</span>$</p>
<p>In words: we assume that there is a “true” value of <span class="math notranslate nohighlight">\(y_i = m x_i + b\)</span> that is linearly related to <span class="math notranslate nohighlight">\(x_i\)</span>.  Then we make a (noisy) observation of <span class="math notranslate nohighlight">\(y_i\)</span>, <span class="math notranslate nohighlight">\(y_{i,\mathrm{obs}} = y_i + \epsilon_i\)</span> where <span class="math notranslate nohighlight">\(\epsilon_i \sim N\left( 0, \sigma_i \right)\)</span> is the random “noise” contaminating our measurement.</p>
<p>Fitting the model to our data is straightforward:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">trace_linear</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/35/vcq24mtj2_g5wk96mbck0cw400018s/T/ipykernel_83870/1043220295.py:2: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_linear = pm.sample()
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [b, m]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='4000' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [4000/4000 00:02<00:00 Sampling 2 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 2 chains for 1_000 tune and 1_000 draw iterations (2_000 + 2_000 draws total) took 14 seconds.
</pre></div>
</div>
</div>
</div>
<p>Looking at the trace plots, we see that there is good “mixing” between the two independent chains, and within each chain as well:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_linear</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;m&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;m&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;ys_true&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;ys_true&#39;}&gt;]], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_15_2.png" src="_images/regression_and_curve_fitting_15_2.png" />
</div>
</div>
<p>We asked our model to output its guess of <span class="math notranslate nohighlight">\(y_i\)</span> at each iteration, via the line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">ys_true</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;ys_true&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="n">xs</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>Our model makes a <em>very strong</em> claim about <span class="math notranslate nohighlight">\(y_i\)</span>: it is <em>exactly</em> predicted by <span class="math notranslate nohighlight">\(m\)</span>, <span class="math notranslate nohighlight">\(b\)</span>, and the given <span class="math notranslate nohighlight">\(x_i\)</span>.  The only uncertainty we have about it is that we don’t know <span class="math notranslate nohighlight">\(m\)</span> and <span class="math notranslate nohighlight">\(b\)</span>!  But we have a large number of measurements, and so quite tightly constrain <span class="math notranslate nohighlight">\(m\)</span> and <span class="math notranslate nohighlight">\(b\)</span> with our data set; correspondingly, the plot below, which compares the uncertainty in the <em>observations</em> (is black) to the uncertainty in the <em>inferences</em> (in blue), the uncertainty about <span class="math notranslate nohighlight">\(y_i\)</span> is substantially reduced by our model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">mean</span><span class="p">(</span><span class="n">trace_linear</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">trace_linear</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Inferred&#39;</span><span class="p">)</span>
<span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys_obs</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x14b17c8e0&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_17_1.png" src="_images/regression_and_curve_fitting_17_1.png" />
</div>
</div>
<p>It is helpful to look at the uncertainty about the model’s estimate of each <span class="math notranslate nohighlight">\(y\)</span> alone:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">mean</span><span class="p">(</span><span class="n">trace_linear</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">trace_linear</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_19_1.png" src="_images/regression_and_curve_fitting_19_1.png" />
</div>
</div>
<p>The inferences about <span class="math notranslate nohighlight">\(y\)</span> become less and certain near the “edges” of the domain.  This is a general feature of regressions: because all the <span class="math notranslate nohighlight">\(y\)</span> are “linked” through the regression formula, nearby (or even distant!) observations inform our estimate of any particular <span class="math notranslate nohighlight">\(y_i\)</span>.  But because of the interaction of uncertainties in our inferences about the slope <span class="math notranslate nohighlight">\(m\)</span> and intercept <span class="math notranslate nohighlight">\(b\)</span> the points in the “middle” are the most constrained, while the ones at the “edges” are less so.  This is particularly clear when we plot “traces” of the fitted lines: for each sample of <span class="math notranslate nohighlight">\(m\)</span> and <span class="math notranslate nohighlight">\(b\)</span>, we draw the corresponding line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys_obs</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="n">trace_linear</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">trace_linear</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">xs</span> <span class="o">+</span> <span class="n">trace_linear</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_21_1.png" src="_images/regression_and_curve_fitting_21_1.png" />
</div>
</div>
<p>In class, we discussed how we could extend this model; here we added a quadratic term to the regression function, fitting
$<span class="math notranslate nohighlight">\(
y = a x^2 + b x + c.
\)</span>$
In a real-life situation, whether this is a natural model extension depends on the physics of the situation; if we, for example, are dealing with a physical environment where a Taylor series is appropriate, then the quadratic function is the “next” natural extension beyond the linear.  In other cases, however, it may not be “natural.”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">quadratic_model</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    
    <span class="n">ys_true</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;ys_true&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">xs</span><span class="p">))</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;ys_obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">ys_true</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">ys_obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">quadratic_model</span><span class="p">:</span>
    <span class="n">quadratic_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/35/vcq24mtj2_g5wk96mbck0cw400018s/T/ipykernel_83870/2923709653.py:2: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  quadratic_trace = pm.sample()
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [a, b, c]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='4000' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [4000/4000 00:04<00:00 Sampling 2 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 2 chains for 1_000 tune and 1_000 draw iterations (2_000 + 2_000 draws total) took 14 seconds.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">quadratic_trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;c&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;c&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;a&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;a&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;ys_true&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;ys_true&#39;}&gt;]], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_25_2.png" src="_images/regression_and_curve_fitting_25_2.png" />
</div>
</div>
<p>Here you can see a similar traceplot of the fitted functions; the “broadening” at the ends of the range is even more apparent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">mean</span><span class="p">(</span><span class="n">quadratic_trace</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">quadratic_trace</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quadratic_trace</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">][</span><span class="n">randint</span><span class="p">(</span><span class="n">quadratic_trace</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys_obs</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_27_1.png" src="_images/regression_and_curve_fitting_27_1.png" />
</div>
</div>
<p>We find that the new “coefficient” is consistent with zero, but not terribly well constrained (the natural “scale” of the data is <span class="math notranslate nohighlight">\(\left| x \right| \simeq 1\)</span>, so <span class="math notranslate nohighlight">\(\left| a \right| \simeq 1\)</span> induces a variation in <span class="math notranslate nohighlight">\(y\)</span> that is also <span class="math notranslate nohighlight">\(\mathcal{O}(1)\)</span> (as can be seen on the above plot).  We “know” that <span class="math notranslate nohighlight">\(a = 0\)</span> because of the way we generated our data; at least the fit is consistent with that.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">quadratic_trace</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$a$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;$a$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_29_1.png" src="_images/regression_and_curve_fitting_29_1.png" />
</div>
</div>
<p>Another possible model extension is to relax our assumption that the true value of <span class="math notranslate nohighlight">\(y\)</span> is given exactly by the fitting formula (<span class="math notranslate nohighlight">\(y = m x + b\)</span> or <span class="math notranslate nohighlight">\(y = a x^2 + b x + c\)</span>); instead, maybe we can assume that the fitting formula gives the <em>average</em> value of <span class="math notranslate nohighlight">\(y\)</span>, but the true value is a random variable distributed normally about the fitting formula.  For simplicity’s sake, we will assume that the scatter around the fitting formula is the same at all values of <span class="math notranslate nohighlight">\(x\)</span>.  Our model is now
$<span class="math notranslate nohighlight">\(
y_i \sim N\left( m x_i + b, \sigma \right)
\)</span><span class="math notranslate nohighlight">\(
and then we have a noisy observation 
\)</span><span class="math notranslate nohighlight">\(
y_{i,\mathrm{obs}} \sim N\left( y_i, \sigma_i \right).
\)</span>$</p>
<p>Graphically, this becomes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$m$&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$b$&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma$&#39;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$x_i$&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$y_i$&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;y_obs&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$y_{i,\mathrm</span><span class="si">{obs}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;sigma_i&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_i$&#39;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_plate</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$i = 1, \ldots, N$&#39;</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;y_obs&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;sigma_i&#39;</span><span class="p">,</span> <span class="s1">&#39;y_obs&#39;</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes:&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_31_1.png" src="_images/regression_and_curve_fitting_31_1.png" />
</div>
</div>
<p>We can learn the “intrinsic scatter” about the fitting relation from this model; the <span class="math notranslate nohighlight">\(\sigma\)</span> parameter represents any extra observed scatter beyond what is supported by the observational uncertainty.  In the limit that <span class="math notranslate nohighlight">\(\sigma \to 0\)</span> we recover the original model above, where the true values of <span class="math notranslate nohighlight">\(y\)</span> follow the fitting relation perfectly.</p>
<p>In many settings (econometrics, for example), there may not be <em>any</em> measurement error (i.e. our <span class="math notranslate nohighlight">\(\sigma_i = 0\)</span>), but nevertheless there can be effects in the system being modeled that are not captured by the fitting formula; to the extent that such effects are “random” in the <span class="math notranslate nohighlight">\(x_i\)</span>, a model such as this one, with intrinsic scatter, can be appropriate.  Even if the effects <em>are</em> dependent on <span class="math notranslate nohighlight">\(x_i\)</span>, including the extra flexibility to permit scatter off the relation can lead to more robust inferences than a model that forces <span class="math notranslate nohighlight">\(y_i = m x_i + b\)</span>.</p>
<p>The <span class="math notranslate nohighlight">\(\sigma \to 0\)</span> limit is also tricky for the sampler; when <span class="math notranslate nohighlight">\(\sigma \to 0\)</span> all the true <span class="math notranslate nohighlight">\(y\)</span> values are constrained <em>exactly</em> to the fitting relation, while with <span class="math notranslate nohighlight">\(\sigma \gg 0\)</span> they are free to scatter far from it.  This introduces a non-linear correlation between <span class="math notranslate nohighlight">\(\sigma\)</span> and the true <span class="math notranslate nohighlight">\(y\)</span> values that takes on a funnel shape; it is known as <a class="reference external" href="https://mc-stan.org/docs/2_18/stan-users-guide/reparameterization-section.html">Neal’s funnel</a> after <span id="id1">[<a class="reference internal" href="bibliography.html#id8">Neal, 2000</a>]</span>.  We can eliminate this correlation by sampling instead over a variable, <span class="math notranslate nohighlight">\(\delta \hat{y}_i\)</span>, which represents the deviation in each <span class="math notranslate nohighlight">\(y_i\)</span> from the fitting relation in units of the scatter <span class="math notranslate nohighlight">\(\sigma\)</span>:
$<span class="math notranslate nohighlight">\(
y_i = m x_i + b + \sigma \delta \hat{y}_i.
\)</span><span class="math notranslate nohighlight">\(
Appling a standard normal distribution to \)</span>\hat{y}_i<span class="math notranslate nohighlight">\( induces a \)</span>N\left( m x_i + b, \sigma \right)<span class="math notranslate nohighlight">\( distribution on \)</span>y_i$.  The re-parameterization replaces the commented-out line</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># ys_true = pm.Normal(&quot;ys_true&quot;, mu=m*xs+b, sigma=sigma)</span>
</pre></div>
</div>
<p>with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">dy_unit</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;dy_unit&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ys_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">ys_true</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;ys_true&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="n">xs</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="n">sigma</span><span class="o">*</span><span class="n">dy_unit</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">intrinsic_error_model</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># ys_true = pm.Normal(&quot;ys_true&quot;, mu=m*xs+b, sigma=sigma)    </span>
    <span class="n">dy_unit</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;dy_unit&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ys_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">ys_true</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;ys_true&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="n">xs</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="n">sigma</span><span class="o">*</span><span class="n">dy_unit</span><span class="p">)</span>
    
    <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;ys_obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">ys_true</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">ys_obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">intrinsic_error_model</span><span class="p">:</span>
    <span class="n">trace_intrinsic</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/35/vcq24mtj2_g5wk96mbck0cw400018s/T/ipykernel_83870/2730893626.py:2: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_intrinsic = pm.sample()
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [dy_unit, sigma, b, m]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='4000' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [4000/4000 00:04<00:00 Sampling 2 chains, 4 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 2 chains for 1_000 tune and 1_000 draw iterations (2_000 + 2_000 draws total) took 12 seconds.
There was 1 divergence after tuning. Increase `target_accept` or reparameterize.
There were 3 divergences after tuning. Increase `target_accept` or reparameterize.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_intrinsic</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;m&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;m&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;dy_unit&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;dy_unit&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;sigma&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;sigma&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;ys_true&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;ys_true&#39;}&gt;]], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_35_2.png" src="_images/regression_and_curve_fitting_35_2.png" />
</div>
</div>
<p>Now we can look at the inferences about the true <span class="math notranslate nohighlight">\(y_i\)</span> in this model.  We see that they follow, more or less, the linear relation, but there is “structure” from the random observational scatter imprinted in their inferences.  The “intrinsic scatter” model weighs the scatter inferred about the relation represented by <span class="math notranslate nohighlight">\(\sigma\)</span> against the observational uncertainties <span class="math notranslate nohighlight">\(\sigma_i\)</span> for each data point.  The true value is a compromise between the relation and the observation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">trace_intrinsic</span><span class="p">[</span><span class="s2">&quot;ys_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">trace_intrinsic</span><span class="p">[</span><span class="s2">&quot;ys_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Posterior&quot;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_37_1.png" src="_images/regression_and_curve_fitting_37_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">trace_intrinsic</span><span class="p">[</span><span class="s2">&quot;ys_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">trace_intrinsic</span><span class="p">[</span><span class="s2">&quot;ys_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Posterior&quot;</span><span class="p">)</span>
<span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys_obs</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observations&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x14cc39c70&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_38_1.png" src="_images/regression_and_curve_fitting_38_1.png" />
</div>
</div>
<p>Our inference about <span class="math notranslate nohighlight">\(\sigma\)</span> suggests that it is rather small (considerably smaller than the observational uncertainty).  In truth <span class="math notranslate nohighlight">\(\sigma = 0\)</span> (our data were generated from a strictly-linear model); with enough observations we could eventually constrain <span class="math notranslate nohighlight">\(\sigma\)</span> to be quite small.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">trace_intrinsic</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$p\left( \sigma \right)$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$p\\left( \\sigma \\right)$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_40_1.png" src="_images/regression_and_curve_fitting_40_1.png" />
</div>
</div>
<div class="section" id="uncertian-about-x">
<h3>Uncertian About <span class="math notranslate nohighlight">\(x\)</span>?<a class="headerlink" href="#uncertian-about-x" title="Permalink to this headline">¶</a></h3>
<p>Let’s explore our linear regression example as if we were uncertain about <span class="math notranslate nohighlight">\(x\)</span> as well.  We will generate some <span class="math notranslate nohighlight">\(x\)</span> observations that reflect the uniformly-spaced <span class="math notranslate nohighlight">\(x\)</span> values with some observational error (normally distributed):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sigma_x</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">xs_obs</span> <span class="o">=</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">sigma_x</span> <span class="o">*</span> <span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>

<span class="n">errorbar</span><span class="p">(</span><span class="n">xs_obs</span><span class="p">,</span> <span class="n">ys_obs</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_43_1.png" src="_images/regression_and_curve_fitting_43_1.png" />
</div>
</div>
<p>Now our graphical model must be extended to include the <span class="math notranslate nohighlight">\(x\)</span> observations and (unknown) true values of <span class="math notranslate nohighlight">\(x\)</span>.  We need some parameters (here denoted <span class="math notranslate nohighlight">\(\theta\)</span>) that describe the way that the true <span class="math notranslate nohighlight">\(x_i\)</span> are distributed.  (We need to assume <em>something</em> about how the <span class="math notranslate nohighlight">\(x\)</span> values are distributed; even if we specify <em>no</em> “population” for the <span class="math notranslate nohighlight">\(x\)</span>, that, in itself, is assuming that they are uniformly distributed along the <span class="math notranslate nohighlight">\(x\)</span>–axis without any bounds.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$m$&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$b$&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_plate</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span> <span class="sa">r</span><span class="s1">&#39;$i = 1, \ldots, N$&#39;</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$y_i$&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$x_i$&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;yobs&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$y_{i,\mathrm</span><span class="si">{obs}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;xobs&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$x_{i,\mathrm</span><span class="si">{obs}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_{y,i}$&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_{x,i}$&#39;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\theta$&#39;</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yobs&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;xobs&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">,</span> <span class="s1">&#39;yobs&#39;</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">,</span> <span class="s1">&#39;xobs&#39;</span><span class="p">)</span>

<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes:&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_45_1.png" src="_images/regression_and_curve_fitting_45_1.png" />
</div>
</div>
<p>We can encode this model using <code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> below; here we assume that <span class="math notranslate nohighlight">\(x \sim U(l, u)\)</span> are uniformly distributed between unknown bounds, which is close to correct. (In fact, the true <span class="math notranslate nohighlight">\(x\)</span> values were chosen <em>uniformly spaced</em> along the <span class="math notranslate nohighlight">\(x\)</span> axis, which is not quite the same thing; but at least they have uniform density.) Other popular choices include using a Gaussian or mixture of Gaussians along the <span class="math notranslate nohighlight">\(x\)</span> axis, as in <span id="id2">[<a class="reference internal" href="bibliography.html#id11">Kelly, 2007</a>]</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">x_uncert_model</span><span class="p">:</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">xs_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s2">&quot;xs&quot;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">xs_obs</span><span class="p">))</span>
    
    <span class="n">m</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    
    <span class="n">ys_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;ys&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="n">xs_model</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;ys_obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">ys_model</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">ys_obs</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;xs_obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">xs_model</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">xs_obs</span><span class="p">)</span>
    
    <span class="n">x_uncert_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/35/vcq24mtj2_g5wk96mbck0cw400018s/T/ipykernel_83870/1928717255.py:14: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  x_uncert_trace = pm.sample(draws=1000, tune=1000)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [b, m, xs, u, l]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='4000' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [4000/4000 00:06<00:00 Sampling 2 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 2 chains for 1_000 tune and 1_000 draw iterations (2_000 + 2_000 draws total) took 13 seconds.
The number of effective samples is smaller than 25% for some parameters.
</pre></div>
</div>
</div>
</div>
<p>We can see that our trace looks good (the mixing along the chain looks reasonable).  Note that our model has inferences about the true <span class="math notranslate nohighlight">\(x\)</span> and true <span class="math notranslate nohighlight">\(y\)</span>, and that we do a reasonable job inferring that the bounds on <span class="math notranslate nohighlight">\(x\)</span> are <span class="math notranslate nohighlight">\(-1 &lt; x &lt; 1\)</span> from the observations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">x_uncert_trace</span><span class="p">,</span> 
              <span class="n">lines</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="mi">1</span><span class="p">),</span>
                     <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">m_true</span><span class="p">),</span>
                     <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">b_true</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;l&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;l&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;u&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;u&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;m&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;m&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;xs&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;xs&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;ys&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;ys&#39;}&gt;]], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_49_2.png" src="_images/regression_and_curve_fitting_49_2.png" />
</div>
</div>
<p>We can plot the mean and standard deviation of the inferred <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> values against the observations, as well as the inferred linear relationship between <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(x\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs_obs</span><span class="p">,</span> <span class="n">ys_obs</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span><span class="p">)</span>
<span class="n">errorbar</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">x_uncert_trace</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">mean</span><span class="p">(</span><span class="n">x_uncert_trace</span><span class="p">[</span><span class="s1">&#39;ys&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">xerr</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">x_uncert_trace</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">x_uncert_trace</span><span class="p">[</span><span class="s1">&#39;ys&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fit&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="n">x_uncert_trace</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lab</span> <span class="o">=</span> <span class="s1">&#39;Linear&#39;</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">lab</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x_uncert_trace</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">xs</span> <span class="o">+</span> <span class="n">x_uncert_trace</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>

<span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_51_1.png" src="_images/regression_and_curve_fitting_51_1.png" />
</div>
</div>
</div>
<div class="section" id="treatment-of-outliers">
<h3>Treatment of Outliers<a class="headerlink" href="#treatment-of-outliers" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Ngood</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">Noutlier</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Ngood</span><span class="p">)</span>

<span class="n">ys_obs</span> <span class="o">=</span> <span class="n">ys_true</span> <span class="o">+</span> <span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ys_true</span><span class="p">))</span>
<span class="n">ys_obs</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">ys_obs</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">rand</span><span class="p">(</span><span class="n">Noutlier</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">))</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">xs</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">rand</span><span class="p">(</span><span class="n">Noutlier</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">[:</span><span class="n">Ngood</span><span class="p">],</span> <span class="n">ys_obs</span><span class="p">[:</span><span class="n">Ngood</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">[:</span><span class="n">Ngood</span><span class="p">]),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">Ngood</span><span class="p">:],</span> <span class="n">ys_obs</span><span class="p">[</span><span class="n">Ngood</span><span class="p">:],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">[</span><span class="n">Ngood</span><span class="p">:]),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y_\mathrm</span><span class="si">{obs}</span><span class="s1">$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y_\\mathrm{obs}$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_53_1.png" src="_images/regression_and_curve_fitting_53_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">mix_model</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">mu_b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;mu_b&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Lognormal</span><span class="p">(</span><span class="s1">&#39;sigma_b&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    
    <span class="c1"># P_bad = pm.Truncated(pm.Normal(&#39;P_bad&#39;, mu=0.1, sigma=0.1), 0, 1)</span>
    <span class="n">P_bad</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="s1">&#39;P_bad&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">ys_true</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;ys_true&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="n">xs</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="n">logp_good</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="o">-</span><span class="n">P_bad</span><span class="p">)</span> <span class="o">+</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">ys_true</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">))</span><span class="o">.</span><span class="n">logp</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">)</span>
    <span class="n">logp_bad</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P_bad</span><span class="p">)</span> <span class="o">+</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">mu_b</span><span class="o">*</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_b</span><span class="p">)</span><span class="o">.</span><span class="n">logp</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">)</span>

    <span class="n">log_odds</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;log_odds&#39;</span><span class="p">,</span> <span class="n">logp_good</span> <span class="o">-</span> <span class="n">logp_bad</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Potential</span><span class="p">(</span><span class="s1">&#39;likelihood&#39;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="n">logp_good</span><span class="p">,</span> <span class="n">logp_bad</span><span class="p">)))</span>

<span class="c1">#      _ = pm.Mixture(&#39;ys_obs&#39;, [1-P_bad, P_bad], [pm.Normal.dist(mu=ys_true, sigma=ones_like(ys_obs)), pm.Normal.dist(mu=mu_b*ones_like(ys_obs), sigma=sigma_b)],</span>
<span class="c1">#                     observed=ys_obs)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">mix_model</span><span class="p">:</span>
    <span class="n">mix_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/35/vcq24mtj2_g5wk96mbck0cw400018s/T/ipykernel_6088/988333364.py:2: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  mix_trace = pm.sample(draws=1000, tune=1000, chains=1)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Sequential sampling (1 chains in 1 job)
NUTS: [P_bad, sigma_b, mu_b, b, m]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='2000' class='' max='2000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [2000/2000 00:08<00:00 Sampling chain 0, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 1 chain for 1_000 tune and 1_000 draw iterations (1_000 + 1_000 draws total) took 8 seconds.
Only one chain was sampled, this makes it impossible to run some convergence checks
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">mix_trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;m&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;m&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;b&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;mu_b&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;mu_b&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;sigma_b&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;sigma_b&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;P_bad&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;P_bad&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;ys_true&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;ys_true&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;log_odds&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;log_odds&#39;}&gt;]], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_56_2.png" src="_images/regression_and_curve_fitting_56_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">[:</span><span class="n">Ngood</span><span class="p">],</span> <span class="n">ys_obs</span><span class="p">[:</span><span class="n">Ngood</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">[:</span><span class="n">Ngood</span><span class="p">]),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">Ngood</span><span class="p">:],</span> <span class="n">ys_obs</span><span class="p">[</span><span class="n">Ngood</span><span class="p">:],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ys_obs</span><span class="p">[</span><span class="n">Ngood</span><span class="p">:]),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">mean</span><span class="p">(</span><span class="n">mix_trace</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">mix_trace</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y_\mathrm</span><span class="si">{obs}</span><span class="s1">$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y_\\mathrm{obs}$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_57_1.png" src="_images/regression_and_curve_fitting_57_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">P_good</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">mix_trace</span><span class="p">[</span><span class="s1">&#39;log_odds&#39;</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)):</span>
    <span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ys_obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">P_good</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mean</span><span class="p">(</span><span class="n">mix_trace</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">]),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">mix_trace</span><span class="p">[</span><span class="s1">&#39;ys_true&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">P_good</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">))</span>

<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y_\mathrm</span><span class="si">{obs}</span><span class="s1">$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y_\\mathrm{obs}$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_58_1.png" src="_images/regression_and_curve_fitting_58_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">mix_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/plots/jointplot.py:144: UserWarning: plot_joint will be deprecated. Please use plot_pair instead.
  warnings.warn(&quot;plot_joint will be deprecated. Please use plot_pair instead.&quot;)
/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&lt;AxesSubplot:xlabel=&#39;m&#39;, ylabel=&#39;b&#39;&gt;, &lt;AxesSubplot:&gt;,
       &lt;AxesSubplot:&gt;], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_59_2.png" src="_images/regression_and_curve_fitting_59_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span><span class="p">,</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">mix_trace</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> <span class="n">mix_trace</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">ss</span>
<span class="n">kde</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">vstack</span><span class="p">((</span><span class="n">ms</span><span class="p">,</span> <span class="n">bs</span><span class="p">)))</span>

<span class="n">scatter</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">M</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
<span class="n">density</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">vstack</span><span class="p">((</span><span class="n">M</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">B</span><span class="o">.</span><span class="n">flatten</span><span class="p">())))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">argmax</span><span class="p">(</span><span class="n">density</span><span class="p">)],</span> <span class="n">B</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">argmax</span><span class="p">(</span><span class="n">density</span><span class="p">)])</span>

<span class="n">contour</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.9292929292929295 -1.3055118110236221
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.contour.QuadContourSet at 0x157578850&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_60_2.png" src="_images/regression_and_curve_fitting_60_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">mix_model</span><span class="p">:</span>
    <span class="n">MAP_pt</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">find_MAP</span><span class="p">()</span>
<span class="n">MAP_pt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='24' class='' max='24' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [24/24 00:00<00:00 logp = -54.226, ||grad|| = 0.017729]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;m&#39;: array(3.00571774),
 &#39;b&#39;: array(-1.34153256),
 &#39;mu_b&#39;: array(1.76066136),
 &#39;sigma_b_log__&#39;: array(0.18795398),
 &#39;P_bad_logodds__&#39;: array(-1.79905388),
 &#39;sigma_b&#39;: array(1.20677798),
 &#39;P_bad&#39;: array(0.14196627),
 &#39;ys_true&#39;: array([-4.3472503 , -4.09677382, -3.84629734, -3.59582086, -3.34534438,
        -3.09486791, -2.84439143, -2.59391495, -2.34343847, -2.09296199,
        -1.84248551, -1.59200903, -1.34153256, -1.09105608, -0.8405796 ,
        -0.59010312, -0.33962664, -0.08915016,  0.16132632,  0.4118028 ,
         0.66227927,  0.91275575,  1.16323223,  1.41370871,  1.66418519,
        -2.90456182, -3.89660144,  0.72168068, -4.30292635,  1.26868037]),
 &#39;log_odds&#39;: array([ 17.33499756,   9.71660512,  10.73547833,   6.0082969 ,
         12.65725767,   6.97471402,   7.03448011,   8.60013597,
          8.47445965,   3.3531636 ,   5.49202821,   4.58622312,
         -1.13299217,   1.49187735,   1.80105317,   3.43673745,
          1.30612868,   1.26443755,   0.35826066,   1.562798  ,
          1.02777543,   0.40732039,  -0.16790211,   0.17051891,
          0.17556296, -13.46745012, -10.92788985,  -0.51394857,
        -29.38412408,   0.16946925])}
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="radial-velocity-curves-and-exoplanet-orbital-parameters">
<h2>Radial Velocity Curves and Exoplanet Orbital Parameters<a class="headerlink" href="#radial-velocity-curves-and-exoplanet-orbital-parameters" title="Permalink to this headline">¶</a></h2>
<p>51 Peg RV data, from <a class="reference external" href="https://exoplanetarchive.ipac.caltech.edu/overview/51%20Peg%20b#overview">IPAC Exoplanet Archive</a>.  These data are reported in <span id="id3">Butler <em>et al.</em> [<a class="reference internal" href="bibliography.html#id6">2006</a>]</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fopeg_data</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;data/ButlerEtAl200651PegUID_0113357_RVC_001.tbl.txt&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
<span class="n">fopeg_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=256</i>
<table id="table5642596992" class="table-striped table-bordered table-condensed">
<thead><tr><th>JD</th><th>Radial_Velocity</th><th>Radial_Velocity_Uncertainty</th></tr></thead>
<thead><tr><th>days</th><th>m / s</th><th>m / s</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>2450002.665695</td><td>-52.9</td><td>4.1</td></tr>
<tr><td>2450002.68434</td><td>-45.8</td><td>4.8</td></tr>
<tr><td>2450002.80022</td><td>-60.8</td><td>4.6</td></tr>
<tr><td>2450002.815961</td><td>-53.3</td><td>5.0</td></tr>
<tr><td>2450002.954711</td><td>-60.9</td><td>5.5</td></tr>
<tr><td>...</td><td>...</td><td>...</td></tr>
<tr><td>2452173.779745</td><td>-44.8</td><td>5.9</td></tr>
<tr><td>2452184.745995</td><td>15.4</td><td>5.5</td></tr>
<tr><td>2452184.776157</td><td>3.9</td><td>5.5</td></tr>
<tr><td>2452189.678866</td><td>-37.8</td><td>5.9</td></tr>
<tr><td>2452189.707882</td><td>-46.2</td><td>6.0</td></tr>
</table></div></div></div>
</div>
<p>This is the period reported by <span id="id4">Butler <em>et al.</em> [<a class="reference internal" href="bibliography.html#id6">2006</a>]</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">P_fop</span> <span class="o">=</span> <span class="mf">4.230785</span> <span class="c1"># (36) uncertainty in the last two digits!</span>
<span class="n">sigma_P_fop</span> <span class="o">=</span> <span class="mf">0.000036</span>

<span class="n">tmid</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot the 51 Peg data with errorbars.  If given, `P` is the period on which the plot should be folded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t - t_\mathrm</span><span class="si">{ref}</span><span class="s1"> / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ \left( t - t_\mathrm</span><span class="si">{ref}</span><span class="s1"> \right) \, \mathrm</span><span class="si">{mod}</span><span class="s1"> \, P / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>
        
    <span class="n">errorbar</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \mathrm</span><span class="si">{m}</span><span class="s1"> \, \mathrm</span><span class="si">{s}</span><span class="s1">^{-1}$&#39;</span><span class="p">)</span>
    
<span class="n">plot_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/regression_and_curve_fitting_67_0.png" src="_images/regression_and_curve_fitting_67_0.png" />
</div>
</div>
<p>Doesn’t look like much, but if we fold on the orbital period:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data</span><span class="p">(</span><span class="n">P</span> <span class="o">=</span> <span class="n">P_fop</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/regression_and_curve_fitting_69_0.png" src="_images/regression_and_curve_fitting_69_0.png" />
</div>
</div>
<p>Note Kepler’s equations (e.g. <span id="id5">Fulton <em>et al.</em> [<a class="reference internal" href="bibliography.html#id7">2018</a>]</span>):
$<span class="math notranslate nohighlight">\(
\frac{2 \pi \left( t - t_0 \right)}{P} = M = E - e \sin E
\)</span><span class="math notranslate nohighlight">\(
with
\)</span><span class="math notranslate nohighlight">\(
\nu = 2 \tan^{-1} \left( \sqrt{\frac{1+e}{1-e}} \tan \frac{E}{2} \right)
\)</span><span class="math notranslate nohighlight">\(
and
\)</span><span class="math notranslate nohighlight">\(
\dot{z} = v_r = K \left( \cos \left( \nu + \omega \right) + e \cos \omega \right),
\)</span>$
where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(t_0\)</span> is the time of pericentre passage of the system.</p></li>
<li><p><span class="math notranslate nohighlight">\(P\)</span> is the period.</p></li>
<li><p><span class="math notranslate nohighlight">\(e\)</span> is the eccentricity.</p></li>
<li><p><span class="math notranslate nohighlight">\(E\)</span> is the “eccentric anomaly”.</p></li>
<li><p><span class="math notranslate nohighlight">\(\nu\)</span> is the “true anomaly”.</p></li>
<li><p><span class="math notranslate nohighlight">\(\omega\)</span> is the argument of pericentre (of the star).</p></li>
<li><p><span class="math notranslate nohighlight">\(K\)</span> is the semi-amplitude of the radial velocity (related to the planet and star masses and the inclination).</p></li>
</ul>
<p>This formula relates something we measure “perfectly”—<span class="math notranslate nohighlight">\(t\)</span>, the time we measure the velocity—to something we measure with uncertainty, the radial velocity.  This is regression.</p>
<p>Below we implement a model that regresses the orbital parameters on the RV observations versus time.</p>
<p><strong>TODO: explain the rationale behind the unusual parameter choices below.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">basic_rv</span><span class="p">:</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Lognormal</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="mf">55.0</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    
    <span class="n">dP</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;dP&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">P_fop</span> <span class="o">+</span> <span class="n">sigma_P_fop</span><span class="o">*</span><span class="n">dP</span><span class="p">)</span>
    
    <span class="c1"># Eccentricity vector:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">UnitDisk</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="n">t0_frac</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s2">&quot;t0_frac&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="n">tmid</span> <span class="o">+</span> <span class="n">P</span><span class="o">*</span><span class="n">t0_frac</span><span class="p">)</span>
    
    <span class="n">orbit</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">orbits</span><span class="o">.</span><span class="n">KeplerianOrbit</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">ecc</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
    
    <span class="n">rv</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;v_r&quot;</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">get_radial_velocity</span><span class="p">(</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">],</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">))</span>
    
    <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;v_r_obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">rv</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_rv_curve</span><span class="p">(</span><span class="n">rvs</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t - t_\mathrm</span><span class="si">{ref}</span><span class="s1"> / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ \left( t - t_\mathrm</span><span class="si">{ref}</span><span class="s1"> \right) \, \mathrm</span><span class="si">{mod}</span><span class="s1"> \, P / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>

    <span class="n">marker</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">scatter</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">rvs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">plot_data</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">)</span>
<span class="n">plot_rv_curve</span><span class="p">(</span><span class="n">pmx</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">basic_rv</span><span class="o">.</span><span class="n">test_point</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">basic_rv</span><span class="p">),</span> <span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/regression_and_curve_fitting_72_0.png" src="_images/regression_and_curve_fitting_72_0.png" />
</div>
</div>
<p>The above plot shows a “guess” at the RV curve with some reasonable, but hardly “optimal” parameters.  We will improve it by optimizing the posterior density (obtaining the (M)aximum (AP)osteriori parameter values) in stages—first we optimize with respect to the phase of pericentre alone, then take that solution and optimize with respect to the phase of pericentre and period, and then finally take that solution and optimize with respect to all variables.  Such “staged” optimization can help avoid falling into a “local maximum” in complicated problems.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">basic_rv</span><span class="p">:</span>
    <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">basic_rv</span><span class="o">.</span><span class="n">test_point</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">t0_frac</span><span class="p">])</span>
    <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">map_soln</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">t0_frac</span><span class="p">,</span> <span class="n">dP</span><span class="p">])</span>
    <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">map_soln</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">t0_frac</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">A</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [t0_frac]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='7' class='' max='7' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [7/7 00:00<00:00 logp = -8.952e+02]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -2244.1075127125005 -&gt; -895.194386147021
optimizing logp for variables: [dP, t0_frac]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='94' class='' max='94' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [94/94 00:00<00:00 logp = -8.921e+02]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -895.194386147021 -&gt; -892.0967029641428
optimizing logp for variables: [A, K, dP, t0_frac]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='153' class='' max='153' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [153/153 00:00<00:00 logp = -8.898e+02]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -892.0967029641428 -&gt; -889.7860524910117
</pre></div>
</div>
</div>
</div>
<p>The solution sure looks pretty optimal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">)</span>
<span class="n">plot_rv_curve</span><span class="p">(</span><span class="n">pmx</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">basic_rv</span><span class="p">),</span> <span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/regression_and_curve_fitting_76_0.png" src="_images/regression_and_curve_fitting_76_0.png" />
</div>
</div>
<p>Now we sample from the posterior over planet parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">basic_rv</span><span class="p">:</span>
    <span class="n">basic_rv_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">draws</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/35/vcq24mtj2_g5wk96mbck0cw400018s/T/ipykernel_40610/3110477701.py:2: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  basic_rv_trace = pm.sample(tune=1000, draws=1000)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [t0_frac, A, dP, K]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='4000' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [4000/4000 00:18<00:00 Sampling 2 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 2 chains for 1_000 tune and 1_000 draw iterations (2_000 + 2_000 draws total) took 30 seconds.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dP</th>
      <td>-2.494</td>
      <td>0.952</td>
      <td>-4.308</td>
      <td>-0.796</td>
      <td>0.021</td>
      <td>0.015</td>
      <td>2145.0</td>
      <td>1346.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>K</th>
      <td>56.065</td>
      <td>0.500</td>
      <td>55.194</td>
      <td>57.071</td>
      <td>0.010</td>
      <td>0.007</td>
      <td>2298.0</td>
      <td>1412.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>P</th>
      <td>4.231</td>
      <td>0.000</td>
      <td>4.231</td>
      <td>4.231</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>2145.0</td>
      <td>1346.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>A[0]</th>
      <td>0.006</td>
      <td>0.010</td>
      <td>-0.013</td>
      <td>0.024</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>1152.0</td>
      <td>1308.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>A[1]</th>
      <td>0.010</td>
      <td>0.009</td>
      <td>-0.008</td>
      <td>0.026</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>2099.0</td>
      <td>1485.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>v_r[251]</th>
      <td>-41.531</td>
      <td>0.989</td>
      <td>-43.424</td>
      <td>-39.763</td>
      <td>0.020</td>
      <td>0.014</td>
      <td>2366.0</td>
      <td>1529.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>v_r[252]</th>
      <td>15.099</td>
      <td>1.401</td>
      <td>12.631</td>
      <td>17.772</td>
      <td>0.029</td>
      <td>0.020</td>
      <td>2329.0</td>
      <td>1591.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>v_r[253]</th>
      <td>12.608</td>
      <td>1.408</td>
      <td>10.103</td>
      <td>15.262</td>
      <td>0.029</td>
      <td>0.021</td>
      <td>2326.0</td>
      <td>1564.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>v_r[254]</th>
      <td>-39.599</td>
      <td>1.097</td>
      <td>-41.616</td>
      <td>-37.520</td>
      <td>0.024</td>
      <td>0.017</td>
      <td>2158.0</td>
      <td>1319.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>v_r[255]</th>
      <td>-41.266</td>
      <td>1.068</td>
      <td>-43.159</td>
      <td>-39.159</td>
      <td>0.023</td>
      <td>0.016</td>
      <td>2128.0</td>
      <td>1330.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>265 rows × 9 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;dP&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;dP&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;K&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;K&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;P&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;P&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;A&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;A&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;e&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;e&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;omega&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;omega&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;t0_frac&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;t0_frac&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;t0&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;t0&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;v_r&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;v_r&#39;}&gt;]], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_80_2.png" src="_images/regression_and_curve_fitting_80_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="s1">&#39;t0&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:ylabel=&#39;P&#39;&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;,
        &lt;AxesSubplot:&gt;],
       [&lt;AxesSubplot:ylabel=&#39;e&#39;&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;,
        &lt;AxesSubplot:&gt;],
       [&lt;AxesSubplot:ylabel=&#39;omega&#39;&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;,
        &lt;AxesSubplot:&gt;],
       [&lt;AxesSubplot:xlabel=&#39;K&#39;, ylabel=&#39;t0&#39;&gt;, &lt;AxesSubplot:xlabel=&#39;P&#39;&gt;,
        &lt;AxesSubplot:xlabel=&#39;e&#39;&gt;, &lt;AxesSubplot:xlabel=&#39;omega&#39;&gt;]],
      dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_81_2.png" src="_images/regression_and_curve_fitting_81_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;A\n0&#39;, ylabel=&#39;A\n1&#39;&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_82_2.png" src="_images/regression_and_curve_fitting_82_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:ylabel=&#39;Count&#39;&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_83_1.png" src="_images/regression_and_curve_fitting_83_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;P&#39;}&gt;]], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_84_2.png" src="_images/regression_and_curve_fitting_84_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/arviz/data/io_pymc3.py:96: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;e&#39;}&gt;]], dtype=object)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_85_2.png" src="_images/regression_and_curve_fitting_85_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">quantile</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.84</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;e = </span><span class="si">{:.4f}</span><span class="s1">^{{+</span><span class="si">{:.4f}</span><span class="s1">}}_{{-</span><span class="si">{:.4f}</span><span class="s1">}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">h</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">-</span><span class="n">l</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>e = 0.0156^{+0.0088}_{-0.0075}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<span class="n">plot_data</span><span class="p">(</span><span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plot_rv_curve</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x1545ffd00&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_87_1.png" src="_images/regression_and_curve_fitting_87_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_residuals</span><span class="p">(</span><span class="n">rvs</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t - t_\mathrm</span><span class="si">{ref}</span><span class="s1"> / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ \left( t - t_\mathrm</span><span class="si">{ref}</span><span class="s1"> \right) \, \mathrm</span><span class="si">{mod}</span><span class="s1"> \, P / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">rvs</span> <span class="o">-</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">]</span>
        <span class="n">sigma_r</span> <span class="o">=</span> <span class="n">ones_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sigma_r</span> <span class="o">=</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">]</span>
        
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">errorbar</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sigma_r</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">plot_residuals</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">P</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]))</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \sigma_</span><span class="si">{v_r}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">figure</span><span class="p">()</span>
<span class="n">plot_residuals</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \sigma_</span><span class="si">{v_r}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">figure</span><span class="p">()</span>
<span class="n">plot_residuals</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \mathrm</span><span class="si">{km}</span><span class="s1"> \, \mathrm</span><span class="si">{s}</span><span class="s1">^{-1}$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$v_r / \\mathrm{km} \\, \\mathrm{s}^{-1}$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_88_1.png" src="_images/regression_and_curve_fitting_88_1.png" />
<img alt="_images/regression_and_curve_fitting_88_2.png" src="_images/regression_and_curve_fitting_88_2.png" />
<img alt="_images/regression_and_curve_fitting_88_3.png" src="_images/regression_and_curve_fitting_88_3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">((</span><span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \mathrm</span><span class="si">{m}</span><span class="s1"> \, \mathrm</span><span class="si">{s}</span><span class="s1">^{-1}$&#39;</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xs</span><span class="o">*</span><span class="n">xs</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$N(0,1)$&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x1546a0cd0&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_89_1.png" src="_images/regression_and_curve_fitting_89_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">basic_rv_linear</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">40</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="n">K</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Lognormal</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="mf">55.0</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    
    <span class="n">dP</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;dP&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">P_fop</span> <span class="o">+</span> <span class="n">sigma_P_fop</span><span class="o">*</span><span class="n">dP</span><span class="p">)</span>
    
    <span class="c1"># Eccentricity vector:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">UnitDisk</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="n">t0_frac</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s2">&quot;t0_frac&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="n">tmid</span> <span class="o">+</span> <span class="n">P</span><span class="o">*</span><span class="n">t0_frac</span><span class="p">)</span>
    
    <span class="n">orbit</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">orbits</span><span class="o">.</span><span class="n">KeplerianOrbit</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">ecc</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
    
    <span class="n">rv_kepler</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;v_r_kepler&quot;</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">get_radial_velocity</span><span class="p">(</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">],</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">))</span>
    <span class="n">rv_linear</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;v_r_linear&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;v_r&#39;</span><span class="p">,</span> <span class="n">rv_kepler</span> <span class="o">+</span> <span class="n">rv_linear</span><span class="p">)</span>
    
    <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;v_r_obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">rv</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have implemented a linear trend, we can have a situation where the linear part is very poorly fit, and the residual is so large that the Keplerian velocity (which is periodic) gets completely washed out.  To avoid that, we will find the optimal parameter values for <em>subsets</em> of the variables of model, starting with the linear parameters <span class="math notranslate nohighlight">\(a\)</span> and <span class="math notranslate nohighlight">\(b\)</span> (and holding the Keplerian fixed to its test values):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">basic_rv_linear</span><span class="p">:</span>
    <span class="n">xbest</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [b, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='6' class='' max='6' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [6/6 00:00<00:00 logp = -2.070e+03]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -2245.2522425983498 -&gt; -2070.0385425373333
</pre></div>
</div>
</div>
</div>
<p>Now we take that optimal linear fit, and allow the period to adapt and find a new optimum:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">basic_rv_linear</span><span class="p">:</span>
    <span class="n">xbest2</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">xbest</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dP</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [dP, b, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='78' class='' max='78' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [78/78 00:00<00:00 logp = -1.818e+03]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -2070.0385425373333 -&gt; -1818.3632481191405
</pre></div>
</div>
</div>
</div>
<p>Let’s check whether the solution seems in any way reasonable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">)</span>
<span class="n">plot_rv_curve</span><span class="p">(</span><span class="n">xbest2</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/regression_and_curve_fitting_96_0.png" src="_images/regression_and_curve_fitting_96_0.png" />
</div>
</div>
<p>It found a reasonable period, but teh phase is wrong; let’s adapt:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">basic_rv_linear</span><span class="p">:</span>
    <span class="n">xbest3</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">xbest2</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">t0_frac</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [t0_frac, A, dP, b, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='60' class='' max='60' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [60/60 00:00<00:00 logp = -8.437e+02]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -1818.3632481191405 -&gt; -843.7361388879683
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">)</span>
<span class="n">plot_rv_curve</span><span class="p">(</span><span class="n">xbest3</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/regression_and_curve_fitting_99_0.png" src="_images/regression_and_curve_fitting_99_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">basic_rv_linear</span><span class="p">:</span>
    <span class="n">xbest4</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">xbest3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [t0_frac, A, dP, K, b, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='17' class='' max='17' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [17/17 00:00<00:00 logp = -8.429e+02]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -843.7361388879683 -&gt; -842.8895196349175
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">)</span>
<span class="n">plot_rv_curve</span><span class="p">(</span><span class="n">xbest4</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">P</span><span class="o">=</span><span class="n">P_fop</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/regression_and_curve_fitting_101_0.png" src="_images/regression_and_curve_fitting_101_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">basic_rv_linear</span><span class="p">:</span>
    <span class="n">basic_rv_linear_trace</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">xbest4</span><span class="p">,</span> <span class="n">draws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/wfarr/miniconda3/envs/Astrostatistics688/lib/python3.9/site-packages/pymc3_ext/sampling/sampling.py:97: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  return pm.sample(draws=draws, tune=tune, model=model, step=step, **kwargs)
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [t0_frac, A, dP, K, b, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='4000' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [4000/4000 00:23<00:00 Sampling 2 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 2 chains for 1_000 tune and 1_000 draw iterations (2_000 + 2_000 draws total) took 35 seconds.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">basic_rv_linear</span><span class="p">:</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">basic_rv_linear_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;t0_frac&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/regression_and_curve_fitting_103_0.png" src="_images/regression_and_curve_fitting_103_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="n">basic_rv_linear_trace</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">basic_rv_linear_trace</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<span class="n">plot_data</span><span class="p">(</span><span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plot_rv_curve</span><span class="p">(</span><span class="n">basic_rv_linear_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x14e474d90&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_104_1.png" src="_images/regression_and_curve_fitting_104_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_residuals</span><span class="p">(</span><span class="n">rvs</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t - t_\mathrm</span><span class="si">{ref}</span><span class="s1"> / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmid</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ \left( t - t_\mathrm</span><span class="si">{ref}</span><span class="s1"> \right) \, \mathrm</span><span class="si">{mod}</span><span class="s1"> \, P / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">rvs</span> <span class="o">-</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">]</span>
        <span class="n">sigma_r</span> <span class="o">=</span> <span class="n">ones_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sigma_r</span> <span class="o">=</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">]</span>
        
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">errorbar</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sigma_r</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">plot_residuals</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_linear_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">P</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_trace</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]))</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \sigma_</span><span class="si">{v_r}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">figure</span><span class="p">()</span>
<span class="n">plot_residuals</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_linear_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \sigma_</span><span class="si">{v_r}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">figure</span><span class="p">()</span>
<span class="n">plot_residuals</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_linear_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \mathrm</span><span class="si">{km}</span><span class="s1"> \, \mathrm</span><span class="si">{s}</span><span class="s1">^{-1}$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$v_r / \\mathrm{km} \\, \\mathrm{s}^{-1}$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_105_1.png" src="_images/regression_and_curve_fitting_105_1.png" />
<img alt="_images/regression_and_curve_fitting_105_2.png" src="_images/regression_and_curve_fitting_105_2.png" />
<img alt="_images/regression_and_curve_fitting_105_3.png" src="_images/regression_and_curve_fitting_105_3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">((</span><span class="n">mean</span><span class="p">(</span><span class="n">basic_rv_linear_trace</span><span class="p">[</span><span class="s1">&#39;v_r&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">fopeg_data</span><span class="p">[</span><span class="s1">&#39;Radial_Velocity_Uncertainty&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \mathrm</span><span class="si">{m}</span><span class="s1"> \, \mathrm</span><span class="si">{s}</span><span class="s1">^{-1}$&#39;</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xs</span><span class="o">*</span><span class="n">xs</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$N(0,1)$&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x14ebaad00&gt;
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_106_1.png" src="_images/regression_and_curve_fitting_106_1.png" />
</div>
</div>
</div>
<div class="section" id="problems">
<h2>Problems<a class="headerlink" href="#problems" title="Permalink to this headline">¶</a></h2>
<div class="section" id="linear-regression">
<h3>Linear Regression<a class="headerlink" href="#linear-regression" title="Permalink to this headline">¶</a></h3>
<p>Read <span id="id6">[<a class="reference internal" href="bibliography.html#id10">Hogg <em>et al.</em>, 2010</a>]</span> (you can find it <a class="reference external" href="https://arxiv.org/abs/1008.4686">here</a>), and do Exercises 6 and 7 (you may wish to warm up on the earlier exercises, too—they should be pretty trivial given what we have been doing for examples in this class).</p>
</div>
<div class="section" id="hd126614a">
<h3>HD126614A<a class="headerlink" href="#hd126614a" title="Permalink to this headline">¶</a></h3>
<p>Let’s try another planet.  This is HD126614A, from <span id="id7">[<a class="reference internal" href="bibliography.html#id9">Howard <em>et al.</em>, 2010</a>]</span> (the data come from an “electronic table” <a class="reference external" href="https://iopscience.iop.org/0004-637X/721/2/1467/suppdata/apj319972t5_ascii.txt?doi=10.1088/0004-637X/721/2/1467">here</a>).  Fit this data to a Keplerian orbit (plus maybe some other terms in the RV?) and compare your fit for the Keplerian parameters to the fit in <span id="id8">[<a class="reference internal" href="bibliography.html#id9">Howard <em>et al.</em>, 2010</a>]</span>.  Be sure to pay attention to setting up the problem for the model so that the variables that are actually sampled over are unit-scale (see above, e.g., the <code class="docutils literal notranslate"><span class="pre">dP</span></code> parameter, etc).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hd126614A_data</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;data/HowardEtAl2010-HD126614A-apj319972t5_ascii.txt&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">header_start</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_start</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">,</span> <span class="s1">&#39;vr&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_vr&#39;</span><span class="p">,</span> <span class="s1">&#39;instrument&#39;</span><span class="p">])</span>
<span class="n">hd126614A_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=70</i>
<table id="table5640143536" class="table-striped table-bordered table-condensed">
<thead><tr><th>JD</th><th>vr</th><th>sigma_vr</th><th>instrument</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th><th>str1</th></tr></thead>
<tr><td>11200.13355</td><td>-175.78</td><td>1.26</td><td>K</td></tr>
<tr><td>11311.92294</td><td>-169.56</td><td>2.17</td><td>K</td></tr>
<tr><td>11342.85107</td><td>-155.44</td><td>1.47</td><td>K</td></tr>
<tr><td>11370.81727</td><td>-151.7</td><td>1.44</td><td>K</td></tr>
<tr><td>11373.83647</td><td>-146.7</td><td>1.77</td><td>K</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>15042.87063</td><td>8.59</td><td>1.45</td><td>K</td></tr>
<tr><td>15043.81939</td><td>3.67</td><td>1.33</td><td>K</td></tr>
<tr><td>15044.79615</td><td>7.78</td><td>1.4</td><td>K</td></tr>
<tr><td>15190.15992</td><td>19.99</td><td>1.34</td><td>K</td></tr>
<tr><td>15197.15781</td><td>21.27</td><td>1.23</td><td>K</td></tr>
<tr><td>15229.04986</td><td>27.36</td><td>1.19</td><td>K</td></tr>
</table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errorbar</span><span class="p">(</span><span class="n">hd126614A_data</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">],</span> <span class="n">hd126614A_data</span><span class="p">[</span><span class="s1">&#39;vr&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">hd126614A_data</span><span class="p">[</span><span class="s1">&#39;sigma_vr&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t / \mathrm</span><span class="si">{d}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_r / \mathrm</span><span class="si">{m}</span><span class="s1"> \, \mathrm</span><span class="si">{s}</span><span class="s1">^{-1}$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$v_r / \\mathrm{m} \\, \\mathrm{s}^{-1}$&#39;)
</pre></div>
</div>
<img alt="_images/regression_and_curve_fitting_113_1.png" src="_images/regression_and_curve_fitting_113_1.png" />
</div>
</div>
</div>
<div class="section" id="a-planet-of-your-choosing">
<h3>A Planet of Your Choosing<a class="headerlink" href="#a-planet-of-your-choosing" title="Permalink to this headline">¶</a></h3>
<p>Fit your favorite planet’s orbital parameters, paying careful attention to describing and assessing the components of the model you are building to represent the data.  Convince me, via appropriate plots / description, that you have accounted for all non-Keplerian effects in the data with your model.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="syllabus.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">PHY 688: Computational Astrophysics Syllabus</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="colored_noise.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Colored Noise</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Will M. Farr<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>